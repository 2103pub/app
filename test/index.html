<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Éâ„Ç≠„É•„É°„É≥„Éà„Çπ„Ç≠„É£„Éä„Éº</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: #f5f5f5;
        color: #333;
        padding: 16px;
    }

    .container {
        max-width: 800px;
        margin: 0 auto;
    }

    h1 {
        font-size: 24px;
        margin-bottom: 8px;
        color: #000;
    }

    .subtitle {
        color: #666;
        font-size: 14px;
        margin-bottom: 20px;
    }

    .camera-box {
        background: white;
        padding: 16px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 16px;
    }

    .video-container {
        position: relative;
        width: 100%;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 16px;
    }

    #video {
        width: 100%;
        display: block;
    }

    #canvas {
        display: none;
    }

    .flash {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.1s;
    }

    .flash.active {
        opacity: 0.8;
    }

    .buttons {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 16px;
    }

    button {
        padding: 16px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.1s;
    }

    button:active {
        transform: scale(0.98);
    }

    button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-primary {
        background: #007aff;
        color: white;
    }

    .btn-success {
        background: #34c759;
        color: white;
        grid-column: 1 / -1;
        font-size: 18px;
        padding: 20px;
    }

    .btn-danger {
        background: #ff3b30;
        color: white;
    }

    .btn-secondary {
        background: #e8e8e8;
        color: #333;
    }

    .settings-box {
        background: white;
        padding: 16px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 16px;
    }

    .settings-box h3 {
        font-size: 18px;
        margin-bottom: 16px;
        color: #000;
    }

    .setting-item {
        margin-bottom: 20px;
    }

    .setting-item label {
        display: block;
        font-size: 14px;
        color: #666;
        margin-bottom: 8px;
        font-weight: 600;
    }

    input[type="range"] {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: #ddd;
        outline: none;
        -webkit-appearance: none;
    }

    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #007aff;
        cursor: pointer;
    }

    .value {
        text-align: right;
        color: #007aff;
        font-weight: 600;
        margin-top: 4px;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px;
        background: #f9f9f9;
        border-radius: 8px;
        margin-bottom: 8px;
    }

    input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }

    .checkbox-item label {
        margin: 0 !important;
        cursor: pointer;
        flex: 1;
        color: #000 !important;
        font-weight: 500 !important;
    }

    .scanned-box {
        background: white;
        padding: 16px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .scanned-box h3 {
        font-size: 18px;
        margin-bottom: 16px;
        color: #000;
    }

    .grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
    }

    .scan-item {
        position: relative;
        aspect-ratio: 3/4;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid #ddd;
        cursor: pointer;
        background: #f5f5f5;
    }

    .scan-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .scan-actions {
        position: absolute;
        top: 4px;
        right: 4px;
        display: flex;
        gap: 4px;
    }

    .action-btn {
        background: rgba(0,0,0,0.7);
        color: white;
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }

    .message {
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 16px;
        font-weight: 600;
    }

    .message.success {
        background: #d4edda;
        color: #155724;
    }

    .message.error {
        background: #f8d7da;
        color: #721c24;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .modal.active {
        display: flex;
    }

    .modal img {
        max-width: 100%;
        max-height: 90vh;
        border-radius: 8px;
    }

    .close-modal {
        position: absolute;
        top: 20px;
        right: 20px;
        background: white;
        color: #000;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 24px;
        cursor: pointer;
    }

    .edit-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.95);
        z-index: 2000;
        padding: 12px;
    }

    .edit-modal.active {
        display: block;
    }

    .edit-container {
        width: 100%;
        height: 100%;
        background: white;
        border-radius: 12px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .edit-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .edit-header h2 {
        font-size: 20px;
        color: #000;
    }

    .edit-canvas-box {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f5f5f5;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
        min-height: 300px;
    }

    #editCanvas {
        max-width: 100%;
        max-height: 100%;
        display: block;
        touch-action: none;
    }

    .edit-tools {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .tool-row {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .tool-row::-webkit-scrollbar {
        display: none;
    }

    .tool-btn {
        padding: 12px 16px;
        background: #e8e8e8;
        color: #000;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .tool-btn:active {
        background: #d0d0d0;
    }

    .tool-btn.active {
        background: #007aff;
        color: white;
    }

    .tool-btn:disabled {
        opacity: 0.4;
    }
</style>
```

</head>
<body>
    <div class="container">
        <h1>üì∏ „Éâ„Ç≠„É•„É°„É≥„Éà„Çπ„Ç≠„É£„Éä„Éº</h1>
        <p class="subtitle">È´òÂìÅË≥™„Çπ„Ç≠„É£„É≥„ÉªÁ∑®ÈõÜ„Éª‰∏ÄÊã¨‰øùÂ≠ò</p>

```
    <div id="message"></div>

    <div class="camera-box">
        <div class="video-container">
            <video id="video" autoplay playsinline></video>
            <div id="flash" class="flash"></div>
        </div>
        <canvas id="canvas"></canvas>

        <div class="buttons">
            <button id="startBtn" class="btn-primary">üì∑ „Ç´„É°„É©Ëµ∑Âãï</button>
            <button id="captureBtn" class="btn-success" disabled>üì∏ ÊíÆÂΩ±</button>
            <button id="saveBtn" class="btn-primary" disabled>üíæ ‰∏ÄÊã¨‰øùÂ≠ò</button>
            <button id="pdfBtn" class="btn-primary" disabled>üìÑ PDFÂá∫Âäõ</button>
            <button id="clearBtn" class="btn-danger" disabled>üóëÔ∏è „Åô„Åπ„Å¶ÂâäÈô§</button>
        </div>
    </div>

    <div class="settings-box">
        <h3>‚öôÔ∏è Ë®≠ÂÆö</h3>
        
        <div class="setting-item">
            <label>Êòé„Çã„Åï</label>
            <input type="range" id="brightness" min="-50" max="50" value="0">
            <div class="value"><span id="brightnessVal">0</span></div>
        </div>

        <div class="setting-item">
            <label>„Ç≥„É≥„Éà„É©„Çπ„Éà</label>
            <input type="range" id="contrast" min="0" max="200" value="100">
            <div class="value"><span id="contrastVal">100</span>%</div>
        </div>

        <div class="setting-item">
            <label>„Ç∑„É£„Éº„Éó„Éç„Çπ</label>
            <input type="range" id="sharpness" min="0" max="100" value="30">
            <div class="value"><span id="sharpnessVal">30</span></div>
        </div>

        <div class="checkbox-item">
            <input type="checkbox" id="glare" checked>
            <label for="glare">ÂèçÂ∞ÑËªΩÊ∏õ</label>
        </div>

        <div class="checkbox-item">
            <input type="checkbox" id="grayscale">
            <label for="grayscale">„Ç∞„É¨„Éº„Çπ„Ç±„Éº„É´</label>
        </div>

        <div class="checkbox-item">
            <input type="checkbox" id="vibrate" checked>
            <label for="vibrate">„Éê„Ç§„Éñ„É¨„Éº„Ç∑„Éß„É≥</label>
        </div>
    </div>

    <div class="scanned-box">
        <h3>üìã „Çπ„Ç≠„É£„É≥Ê∏à„Åø (<span id="count">0</span>)</h3>
        <div id="grid" class="grid"></div>
    </div>
</div>

<div id="modal" class="modal">
    <button class="close-modal" onclick="closeModal()">√ó</button>
    <img id="modalImg" src="" alt="Preview">
</div>

<div id="editModal" class="edit-modal">
    <div class="edit-container">
        <div class="edit-header">
            <h2>‚úèÔ∏è Á∑®ÈõÜ</h2>
            <button class="close-modal" onclick="closeEditModal()">√ó</button>
        </div>
        
        <div class="edit-canvas-box">
            <canvas id="editCanvas"></canvas>
        </div>

        <div class="edit-tools">
            <div class="tool-row">
                <button class="tool-btn" id="undoBtn" onclick="undo()" disabled>‚Ü∂ Êàª„Çã</button>
                <button class="tool-btn" id="redoBtn" onclick="redo()" disabled>‚Ü∑ ÈÄ≤„ÇÄ</button>
                <button class="tool-btn" id="cropBtn" onclick="toggleCrop()">‚úÇÔ∏è „Éà„É™„Éü„É≥„Ç∞</button>
                <button class="tool-btn" onclick="rotate(90)">‚Üª Âè≥ÂõûËª¢</button>
                <button class="tool-btn" onclick="rotate(-90)">‚Ü∫ Â∑¶ÂõûËª¢</button>
            </div>
            <div class="tool-row">
                <button class="tool-btn" onclick="filter('grayscale')">‚¨õ „Ç∞„É¨„Éº</button>
                <button class="tool-btn" onclick="filter('blackwhite')">‚óºÔ∏è ÁôΩÈªí</button>
                <button class="tool-btn" onclick="filter('sepia')">üü§ „Çª„Éî„Ç¢</button>
                <button class="tool-btn" onclick="filter('invert')">üîÑ ÂèçËª¢</button>
                <button class="tool-btn" onclick="resetEdit()">üîÑ „É™„Çª„ÉÉ„Éà</button>
            </div>
            <div class="tool-row">
                <button class="btn-success" style="flex: 1;" onclick="saveEdit()">üíæ ‰øùÂ≠ò</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
    let video, canvas, ctx;
    let scans = [];

    document.addEventListener('DOMContentLoaded', () => {
        video = document.getElementById('video');
        canvas = document.getElementById('canvas');
        ctx = canvas.getContext('2d');

        document.getElementById('startBtn').addEventListener('click', startCamera);
        document.getElementById('captureBtn').addEventListener('click', capture);
        document.getElementById('saveBtn').addEventListener('click', saveAll);
        document.getElementById('pdfBtn').addEventListener('click', exportPDF);
        document.getElementById('clearBtn').addEventListener('click', clearAll);

        ['brightness', 'contrast', 'sharpness'].forEach(id => {
            document.getElementById(id).addEventListener('input', e => {
                let val = e.target.value;
                if (id === 'contrast') val += '%';
                document.getElementById(id + 'Val').textContent = val;
            });
        });

        updateCount();
    });

    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment' }
            });
            video.srcObject = stream;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('captureBtn').disabled = false;
            showMessage('„Ç´„É°„É©„ÇíËµ∑Âãï„Åó„Åæ„Åó„Åü', 'success');
        } catch (err) {
            showMessage('„Ç´„É°„É©„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
        }
    }

    function capture() {
        const flash = document.getElementById('flash');
        flash.classList.add('active');
        setTimeout(() => flash.classList.remove('active'), 100);

        if (document.getElementById('vibrate').checked && navigator.vibrate) {
            navigator.vibrate(30);
        }

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);

        let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

        if (document.getElementById('glare').checked) {
            imageData = reduceGlare(imageData);
        }

        imageData = adjustBrightness(imageData);
        imageData = adjustContrast(imageData);
        imageData = applySharpen(imageData);

        if (document.getElementById('grayscale').checked) {
            imageData = toGrayscale(imageData);
        }

        ctx.putImageData(imageData, 0, 0);

        const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
        scans.push(dataUrl);
        updateGrid();
        updateCount();

        document.getElementById('saveBtn').disabled = false;
        document.getElementById('pdfBtn').disabled = false;
        document.getElementById('clearBtn').disabled = false;

        showMessage('ÊíÆÂΩ±„Åó„Åæ„Åó„Åü', 'success');
    }

    function reduceGlare(imageData) {
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            const brightness = (data[i] + data[i+1] + data[i+2]) / 3;
            if (brightness > 200) {
                const factor = 200 / brightness;
                data[i] *= factor;
                data[i+1] *= factor;
                data[i+2] *= factor;
            }
        }
        return imageData;
    }

    function adjustBrightness(imageData) {
        const data = imageData.data;
        const val = parseInt(document.getElementById('brightness').value);
        for (let i = 0; i < data.length; i += 4) {
            data[i] = Math.max(0, Math.min(255, data[i] + val));
            data[i+1] = Math.max(0, Math.min(255, data[i+1] + val));
            data[i+2] = Math.max(0, Math.min(255, data[i+2] + val));
        }
        return imageData;
    }

    function adjustContrast(imageData) {
        const data = imageData.data;
        const val = parseInt(document.getElementById('contrast').value) / 100;
        for (let i = 0; i < data.length; i += 4) {
            data[i] = Math.max(0, Math.min(255, (data[i] - 128) * val + 128));
            data[i+1] = Math.max(0, Math.min(255, (data[i+1] - 128) * val + 128));
            data[i+2] = Math.max(0, Math.min(255, (data[i+2] - 128) * val + 128));
        }
        return imageData;
    }

    function applySharpen(imageData) {
        const val = parseInt(document.getElementById('sharpness').value);
        if (val === 0) return imageData;
        
        const data = imageData.data;
        const w = imageData.width;
        const h = imageData.height;
        const output = new Uint8ClampedArray(data);
        const amount = val / 100;

        for (let y = 1; y < h - 1; y++) {
            for (let x = 1; x < w - 1; x++) {
                for (let c = 0; c < 3; c++) {
                    const idx = (y * w + x) * 4 + c;
                    const top = ((y-1) * w + x) * 4 + c;
                    const bottom = ((y+1) * w + x) * 4 + c;
                    const left = (y * w + (x-1)) * 4 + c;
                    const right = (y * w + (x+1)) * 4 + c;
                    
                    const sharp = data[idx] * (1 + 4 * amount) - 
                                (data[top] + data[bottom] + data[left] + data[right]) * amount;
                    output[idx] = Math.max(0, Math.min(255, sharp));
                }
            }
        }

        return new ImageData(output, w, h);
    }

    function toGrayscale(imageData) {
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            const gray = data[i] * 0.299 + data[i+1] * 0.587 + data[i+2] * 0.114;
            data[i] = data[i+1] = data[i+2] = gray;
        }
        return imageData;
    }

    function updateGrid() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        scans.forEach((url, i) => {
            const item = document.createElement('div');
            item.className = 'scan-item';
            item.onclick = () => showModal(url);

            const img = document.createElement('img');
            img.src = url;

            const actions = document.createElement('div');
            actions.className = 'scan-actions';

            const editBtn = document.createElement('button');
            editBtn.className = 'action-btn';
            editBtn.innerHTML = '‚úèÔ∏è';
            editBtn.onclick = (e) => {
                e.stopPropagation();
                openEditModal(i);
            };

            const delBtn = document.createElement('button');
            delBtn.className = 'action-btn';
            delBtn.innerHTML = '√ó';
            delBtn.onclick = (e) => {
                e.stopPropagation();
                scans.splice(i, 1);
                updateGrid();
                updateCount();
                if (scans.length === 0) {
                    document.getElementById('saveBtn').disabled = true;
                    document.getElementById('pdfBtn').disabled = true;
                    document.getElementById('clearBtn').disabled = true;
                }
            };

            actions.appendChild(editBtn);
            actions.appendChild(delBtn);
            item.appendChild(img);
            item.appendChild(actions);
            grid.appendChild(item);
        });
    }

    function updateCount() {
        document.getElementById('count').textContent = scans.length;
    }

    function showModal(url) {
        document.getElementById('modalImg').src = url;
        document.getElementById('modal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('modal').classList.remove('active');
    }

    async function saveAll() {
        const zip = new JSZip();
        const date = new Date().toISOString().split('T')[0];

        scans.forEach((url, i) => {
            const base64 = url.split(',')[1];
            zip.file(`scan_${i+1}.jpg`, base64, {base64: true});
        });

        const blob = await zip.generateAsync({type: 'blob'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `scans_${date}.zip`;
        link.click();

        showMessage('‰∏ÄÊã¨‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
    }

    async function exportPDF() {
        const {jsPDF} = window.jspdf;
        const pdf = new jsPDF();

        for (let i = 0; i < scans.length; i++) {
            if (i > 0) pdf.addPage();

            const img = new Image();
            img.src = scans[i];

            await new Promise(resolve => {
                img.onload = () => {
                    const w = pdf.internal.pageSize.getWidth();
                    const h = pdf.internal.pageSize.getHeight();
                    const ratio = img.width / img.height;
                    const pageRatio = w / h;

                    let fw, fh;
                    if (ratio > pageRatio) {
                        fw = w - 20;
                        fh = fw / ratio;
                    } else {
                        fh = h - 20;
                        fw = fh * ratio;
                    }

                    const x = (w - fw) / 2;
                    const y = (h - fh) / 2;

                    pdf.addImage(scans[i], 'JPEG', x, y, fw, fh);
                    resolve();
                };
            });
        }

        const date = new Date().toISOString().split('T')[0];
        pdf.save(`scan_${date}.pdf`);
        showMessage('PDF„ÇíÂá∫Âäõ„Åó„Åæ„Åó„Åü', 'success');
    }

    function clearAll() {
        if (confirm('„Åô„Åπ„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
            scans = [];
            updateGrid();
            updateCount();
            document.getElementById('saveBtn').disabled = true;
            document.getElementById('pdfBtn').disabled = true;
            document.getElementById('clearBtn').disabled = true;
            showMessage('„Åô„Åπ„Å¶ÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
        }
    }

    function showMessage(text, type) {
        const msg = document.getElementById('message');
        msg.className = `message ${type}`;
        msg.textContent = text;
        setTimeout(() => msg.textContent = '', 3000);
    }

    document.getElementById('modal').addEventListener('click', (e) => {
        if (e.target.id === 'modal') closeModal();
    });

    // Edit functionality
    let editCanvas, editCtx;
    let currentEditIndex = -1;
    let editHistory = [];
    let historyIndex = -1;
    let cropMode = false;
    let cropStart = null;
    let cropEnd = null;

    function openEditModal(index) {
        currentEditIndex = index;
        editHistory = [];
        historyIndex = -1;
        
        editCanvas = document.getElementById('editCanvas');
        editCtx = editCanvas.getContext('2d');

        const img = new Image();
        img.onload = () => {
            editCanvas.width = img.width;
            editCanvas.height = img.height;
            editCtx.drawImage(img, 0, 0);
            saveHistory();
            document.getElementById('editModal').classList.add('active');
        };
        img.src = scans[index];
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.remove('active');
        cropMode = false;
        document.getElementById('cropBtn').classList.remove('active');
    }

    function saveHistory() {
        const data = editCtx.getImageData(0, 0, editCanvas.width, editCanvas.height);
        editHistory = editHistory.slice(0, historyIndex + 1);
        editHistory.push({
            data: data,
            width: editCanvas.width,
            height: editCanvas.height
        });
        historyIndex++;
        if (editHistory.length > 20) {
            editHistory.shift();
            historyIndex--;
        }
        updateUndoRedo();
    }

    function updateUndoRedo() {
        document.getElementById('undoBtn').disabled = historyIndex <= 0;
        document.getElementById('redoBtn').disabled = historyIndex >= editHistory.length - 1;
    }

    function undo() {
        if (historyIndex > 0) {
            historyIndex--;
            const state = editHistory[historyIndex];
            editCanvas.width = state.width;
            editCanvas.height = state.height;
            editCtx.putImageData(state.data, 0, 0);
            updateUndoRedo();
        }
    }

    function redo() {
        if (historyIndex < editHistory.length - 1) {
            historyIndex++;
            const state = editHistory[historyIndex];
            editCanvas.width = state.width;
            editCanvas.height = state.height;
            editCtx.putImageData(state.data, 0, 0);
            updateUndoRedo();
        }
    }

    function toggleCrop() {
        cropMode = !cropMode;
        const btn = document.getElementById('cropBtn');
        if (cropMode) {
            btn.classList.add('active');
            editCanvas.style.cursor = 'crosshair';
        } else {
            btn.classList.remove('active');
            editCanvas.style.cursor = 'default';
        }
    }

    editCanvas?.addEventListener('mousedown', startCrop);
    editCanvas?.addEventListener('mousemove', drawCrop);
    editCanvas?.addEventListener('mouseup', endCrop);
    editCanvas?.addEventListener('touchstart', (e) => startCrop(e.touches[0]));
    editCanvas?.addEventListener('touchmove', (e) => { e.preventDefault(); drawCrop(e.touches[0]); });
    editCanvas?.addEventListener('touchend', endCrop);

    function startCrop(e) {
        if (!cropMode) return;
        const rect = editCanvas.getBoundingClientRect();
        cropStart = {
            x: (e.clientX - rect.left) * (editCanvas.width / rect.width),
            y: (e.clientY - rect.top) * (editCanvas.height / rect.height)
        };
    }

    function drawCrop(e) {
        if (!cropMode || !cropStart) return;
        const rect = editCanvas.getBoundingClientRect();
        cropEnd = {
            x: (e.clientX - rect.left) * (editCanvas.width / rect.width),
            y: (e.clientY - rect.top) * (editCanvas.height / rect.height)
        };

        const state = editHistory[historyIndex];
        editCtx.putImageData(state.data, 0, 0);

        const x = Math.min(cropStart.x, cropEnd.x);
        const y = Math.min(cropStart.y, cropEnd.y);
        const w = Math.abs(cropEnd.x - cropStart.x);
        const h = Math.abs(cropEnd.y - cropStart.y);

        editCtx.strokeStyle = '#007aff';
        editCtx.lineWidth = 2;
        editCtx.setLineDash([5, 5]);
        editCtx.strokeRect(x, y, w, h);
        editCtx.setLineDash([]);
    }

    function endCrop() {
        if (!cropMode || !cropStart || !cropEnd) return;
        
        const x = Math.min(cropStart.x, cropEnd.x);
        const y = Math.min(cropStart.y, cropEnd.y);
        const w = Math.abs(cropEnd.x - cropStart.x);
        const h = Math.abs(cropEnd.y - cropStart.y);

        if (w < 10 || h < 10) {
            cropStart = null;
            cropEnd = null;
            return;
        }

        const cropped = editCtx.getImageData(x, y, w, h);
        editCanvas.width = w;
        editCanvas.height = h;
        editCtx.putImageData(cropped, 0, 0);
        saveHistory();

        cropStart = null;
        cropEnd = null;
        cropMode = false;
        document.getElementById('cropBtn').classList.remove('active');
    }

    function rotate(deg) {
        const temp = document.createElement('canvas');
        const tempCtx = temp.getContext('2d');

        if (Math.abs(deg) === 90) {
            temp.width = editCanvas.height;
            temp.height = editCanvas.width;
        } else {
            temp.width = editCanvas.width;
            temp.height = editCanvas.height;
        }

        tempCtx.translate(temp.width / 2, temp.height / 2);
        tempCtx.rotate((deg * Math.PI) / 180);
        tempCtx.drawImage(editCanvas, -editCanvas.width / 2, -editCanvas.height / 2);

        editCanvas.width = temp.width;
        editCanvas.height = temp.height;
        editCtx.drawImage(temp, 0, 0);
        saveHistory();
    }

    function filter(type) {
        const imageData = editCtx.getImageData(0, 0, editCanvas.width, editCanvas.height);
        const data = imageData.data;

        switch(type) {
            case 'grayscale':
                for (let i = 0; i < data.length; i += 4) {
                    const gray = data[i] * 0.299 + data[i+1] * 0.587 + data[i+2] * 0.114;
                    data[i] = data[i+1] = data[i+2] = gray;
                }
                break;
            case 'blackwhite':
                for (let i = 0; i < data.length; i += 4) {
                    const gray = data[i] * 0.299 + data[i+1] * 0.587 + data[i+2] * 0.114;
                    const bw = gray > 128 ? 255 : 0;
                    data[i] = data[i+1] = data[i+2] = bw;
                }
                break;
            case 'sepia':
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i], g = data[i+1], b = data[i+2];
                    data[i] = Math.min(255, r * 0.393 + g * 0.769 + b * 0.189);
                    data[i+1] = Math.min(255, r * 0.349 + g * 0.686 + b * 0.168);
                    data[i+2] = Math.min(255, r * 0.272 + g * 0.534 + b * 0.131);
                }
                break;
            case 'invert':
                for (let i = 0; i < data.length; i += 4) {
                    data[i] = 255 - data[i];
                    data[i+1] = 255 - data[i+1];
                    data[i+2] = 255 - data[i+2];
                }
                break;
        }

        editCtx.putImageData(imageData, 0, 0);
        saveHistory();
    }

    function resetEdit() {
        const img = new Image();
        img.onload = () => {
            editCanvas.width = img.width;
            editCanvas.height = img.height;
            editCtx.drawImage(img, 0, 0);
            editHistory = [];
            historyIndex = -1;
            saveHistory();
        };
        img.src = scans[currentEditIndex];
    }

    function saveEdit() {
        scans[currentEditIndex] = editCanvas.toDataURL('image/jpeg', 0.9);
        updateGrid();
        closeEditModal();
        showMessage('Á∑®ÈõÜ„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
    }
</script>
```

</body>
</html>
